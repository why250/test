基于您提供的 `README.md` 文档以及之前对话中关于“配置文件细节”、“计算算法”和“日志规范”的讨论，汇总整理后的《测试功能需求说明书》如下：

---

# 测试功能需求说明书 v2.0

## 1. 项目概述

本项目旨在通过 Python 脚本实现自动化测试功能，涵盖电源的上/下电时序控制、电流范围判定、DAC/电源参数配置以及直流线性度测试与分析 [1]。

---

## 2. 系统环境与接口

* **电源设备 (DP)**：通过 VISA 协议连接。地址读取自 `visa.txt`（例如：`USB0::0x1AB1::0xA4A8::DP2A265201089::INSTR`）[1]。
* **DAC 设备**：通过串口 (COM) 连接，使用波特率等标准串口参数 [1]。
* **万用表 (DM)**：用于线性度测试中的输出参数读取 [1]。
* **信号发生器 (DG)**：可选，作为线性度测试的输入源之一 [1]。

---

## 3. 功能需求详情

### 3.1 上电顺序控制 (Power On)

1. **读取配置**：
   * 加载 `Power_on_config.txt`，获取上电顺序。
   * **格式**：`(DP名称, 通道号, 目标电压V, 限流A)` [1]。
2. **执行动作**：
   * 按文件定义的顺序依次开启电源通道。
   * 上电稳定后读取实际电流值 [1]。
3. **判定结果**：
   * 加载 `Power_limit_config.txt`，获取判定阈值。
   * **格式**：`(DP名称, 通道号, 下限电流A, 上限电流A)`。
   * 逻辑：若 `下限 <= 实测电流 <= 上限`，则判定为 PASS，否则为 FAIL [1]。
4. **结果保存**：
   * 生成文件：`"Power_on_result" + 测试时间 + ".txt"`。
   * 内容需包含通道信息、实测值、阈值范围及判定结果 [1]。

### 3.2 下电顺序控制 (Power Off)

* **执行逻辑**：读取 `Power_on_config.txt`（或专用下电配置），按照与上电顺序**完全相反**的次序关闭通道 [1]。

### 3.3 设备配置 (Configuration)

#### 3.3.1 DAC 配置

* **配置文件**：`DAC_Config.txt`。
* **格式**：`DACx 档位(2.5/5/10/20) 电压值` [1]。
* **控制逻辑**：
  * 解析档位与电压值，转换为 **16bit DAC 码**。
  * 生成命令格式：`f"OUTPUT{i} {channel} {dac_code};"`。
  * 通过串口发送命令 [1]。
* **扫描功能**：支持指定某一通道（如 DAC20）进行线性扫描（初值、终值、步进）[1]。

#### 3.3.2 电源配置

* **配置文件**：`Power_Config.txt`。
* **逻辑**：独立于上电流程的电源参数设置，格式与上电配置一致 [1]。

### 3.4 直流线性度测试 (DC Linearity)

1. **输入源扫描**：支持两种模式。
   * 模式 A：扫描 DAC 指定通道（设置初值、终值、步进）。
   * 模式 B：扫描 DG 直流输出（设置初值、终值、步进）[1]。
2. **数据采集**：在每一步进点，通过万用表 (DM) 读取输出值 [1]。
3. **分析与计算**：
   * 绘制 XY 散点图（输入参数 vs 输出参数）。
   * **计算指标**：Gain（增益）、Offset（偏移）、Non-linearity、DNL（微分非线性）、INL（积分非线性）[1]。
4. **结果输出**：
   * 默认保存路径：`./results`。
   * 文件名格式：`"dc_linearity_result" + 测试时间 + ".txt"` [1]。

---

## 4. 关键算法说明

（基于之前对话补充的计算逻辑）

* **Gain & Offset**：
  * 方法：最小二乘法线性拟合 ($Y = Gain \times X + Offset$)。
* **DNL (微分非线性)**：
  * 公式：$DNL_i = \frac{V_{meas}(i) - V_{meas}(i-1)}{LSB_{ideal}} - 1$
  * 说明：描述实际步进与理想步进的偏差。
* **INL (积分非线性)**：
  * 公式：$INL_i = \frac{V_{meas}(i) - V_{fit}(i)}{LSB_{ideal}}$
  * 说明：描述实测值与拟合直线理论值的偏差。

---

## 5. 文件与日志规范

### 5.1 文件命名

所有输出文件必须包含时间戳，建议格式为 `YYYYMMDD_HHMMSS`，以确保唯一性并避免覆盖 [1]。

### 5.2 输入文件约束

* **visa.txt**：单行字符串，VISA 资源地址 [1]。
* **DAC_Config.txt**：档位字段严格限制为 `2.5, 5, 10, 20` 四种数值 [1]。

### 5.3 异常处理与日志

* **连接错误**：若 VISA 或串口连接失败，记录 **CRITICAL** 级日志并中止测试。
* **范围错误**：若上电电流超出 Limit 范围，记录 **FAIL** 日志但不一定中止后续非依赖性测试（视策略而定）。
* **格式错误**：若配置文件解析失败（如缺少逗号），记录 **ERROR** 提示用户检查文件格式。
