这是一份针对**CP测试挑片（Wafer Sort）**的软件需求规格说明书。它在原有的仪器控制与测试功能基础上，重点补充了**晶圆映射（Wafer Mapping）**、**坐标管理（Site Management）**以及**数据可视化**的需求。

---

# CP测试挑片软件需求规格说明书 (SRS) v1.0

## 1. 项目概述

本项目旨在开发一套用于芯片探针测试（CP Test）的挑片软件。软件需结合自动化测试流程与晶圆物理位置管理，实现“扎针-测试-记录-映射”的闭环。核心目标是建立物理坐标（Row/Col）与测试结果（Pass/Fail/Data）的唯一对应关系，并支持可视化分析。

## 2. 系统核心逻辑架构

系统分为三个层级：

1. **映射管理层 (Mapping Layer)**：负责 Site_ID 与物理坐标 (Row, Col) 的转换，管理测试进度。
2. **自动化控制层 (Automation Layer)**：负责调度测试流程（上电->扫描->下电）和异常处理。
3. **硬件驱动层 (Driver Layer)**：负责 VISA/串口通信，执行具体的电源与DAC指令 [1]。

---

## 3. 详细功能需求

### 3.1 晶圆坐标与 Site_ID 管理

为支持灵活的测试顺序（跳号、重测），系统不直接依赖行列计算，而是基于**Site_ID（连续编号）**进行管理。

* **REQ-MAP-01 (映射表加载)**：
  * 软件需读取外部定义文件 `wafer_layout.csv`。
  * 文件结构：`Site_ID, Row, Col`。
  * 功能：建立 Site_ID 到物理坐标的静态映射字典。
* **REQ-MAP-02 (自动递增模式)**：
  * 默认开启。当一次测试完成且结果保存后，`Current Site_ID` 自动 +1。
  * 界面需即时更新显示下一个待测点的 Row/Col，提示操作员移动探针。
* **REQ-MAP-03 (跳号/指定模式)**：
  * 允许用户在 GUI 手动输入任意 `Site_ID`。
  * 软件需立即查表并更新显示对应的 Row/Col。
* **REQ-MAP-04 (重测支持)**：
  * 当用户输入已测过的 `Site_ID` 并重新开始测试时，**不得覆盖**原始数据。
  * 系统需以“追加（Append）”模式记录新的一行数据，依靠时间戳区分历史记录。

### 3.2 数据结构与 CSV 结果定义

采用“宽表”结构记录单颗芯片的所有测试细节，便于后续生成 Wafer Map。

* **REQ-DATA-01 (文件格式)**：
  * 文件名：`Wafer_Sort_Results.csv`（累加记录）。
  * 写入模式：Append (追加)。
* **REQ-DATA-02 (列结构定义)**：
  CSV 需包含以下字段（按逻辑分组）：
  1. **索引信息**：`Test_Time`, `Site_ID`, `Row`, `Col`。
  2. **总体结论**：`Final_Result` (PASS/FAIL/PARTIAL), `Fail_Reason` (如 "Power_Limit", "INL_Stage3")。
  3. **上电监测**：`Power_Current` [1], `Power_Check_Result` (基于 [4] 判定)。
  4. **分档位详情 (Stage 1-7)**：针对每个增益档位，记录 `Sx_Gain_Config`, `Sx_Input_Amp`, `Sx_Max_INL`, `Sx_Max_DNL`, `Sx_Result`。
     * *(注：Sx 代表 Stage x，参数源自直流线性度测试需求 [1])*。

### 3.3 自动化测试流程 (挑片专用)

在原有测试流程基础上，增加坐标绑定与安全熔断机制。

1. **准备阶段**：
   * 用户输入/确认 `Site_ID`。
   * 软件锁定当前坐标 `(Row, Col)`。
2. **上电检查 (Critical)**：
   * 执行 `Power on sequence` [1][5]。
   * 读取电流并对比 `Power_limit_config.txt` [4]。
   * **熔断机制**：若电流超标，立即判定 **FAIL**，跳过后续所有线性度测试，直接执行下电，防止烧针/烧片。
3. **多档位线性度测试**：
   * 仅在上电通过后执行。
   * 循环执行 7 个增益档位的 DAC 配置 [2]、电源调整 [3] 与扫描分析 [1]。
   * 记录每个档位的 Pass/Fail 状态。
4. **下电与保存**：
   * 执行 `Power off sequence` [1]。
   * 将内存中的测试数据结合坐标信息，写入 CSV。

### 3.4 可视化：Wafer Map 生成

软件需提供“生成报告”功能，基于 CSV 数据绘制晶圆图谱。

* **REQ-VIS-01 (颜色映射)**：
  * **Green (PASS)**：所有测试项通过。
  * **Red (FAIL)**：上电失败或首个档位即失败。
  * **Yellow (PARTIAL)**：上电通过，部分增益档位线性度超标。
* **REQ-VIS-02 (静态图导出)**：
  * 格式：PNG 图片。
  * 内容：基于 Row/Col 的热力图矩阵，标注 Site_ID 或 Result。
  * 路径：`./results/Wafer_Map_{Time}.png` [1]。
* **REQ-VIS-03 (交互图导出)**：
  * 格式：HTML 文件。
  * 功能：鼠标悬停在特定坐标上时，浮窗显示该芯片的 `Site_ID`, `Max_INL`, `Failure_Reason` 等详细信息。

---

## 4. 输入输出文件清单

| 类型           | 文件名                        | 来源/用途      | 备注                              |
| :------------- | :---------------------------- | :------------- | :-------------------------------- |
| **输入** | `wafer_layout.csv`          | **新增** | 定义 Site_ID 到 (Row, Col) 的映射 |
| **输入** | `visa.txt`                  | [1]            | 仪器连接地址                      |
| **输入** | `Power_on_config.txt`       | [5]            | 上下电时序定义                    |
| **输入** | `Power_limit_config.txt`    | [4]            | 上电电流安全门限                  |
| **输入** | `DAC_Config.txt`            | [2]            | 基础 DAC 配置                     |
| **输入** | `Power_Config.txt`          | [3]            | 基础电源配置                      |
| **输出** | `Wafer_Sort_Results.csv`    | **新增** | 总测试数据记录 (Excel/Map数据源)  |
| **输出** | `Wafer_Map.png/html`        | **新增** | 挑片结果可视化图谱                |
| **输出** | `dc_linearity_result_*.txt` | [1]            | (可选) 保留原始单次测试波形数据   |

## 5. 异常处理

* **重复测试处理**：在生成 Wafer Map 时，若同一坐标存在多条记录，软件应默认取时间戳（Test_Time）最近的一条作为最终状态进行绘图。
* **映射缺失**：若输入的 Site_ID 在 `wafer_layout.csv` 中不存在，软件应禁止启动测试并弹出警告。
