
# 自动化测试软件需求规格说明书 (SRS) v3.0

## 1. 引言

本项目旨在开发一套全自动化测试脚本，通过调用底层 GUI 函数，完成从仪器连接、上电、多档位直流线性度扫描到下电的全流程闭环测试。核心逻辑是根据 7 个增益档位自动计算输入幅度，并动态调整 DAC 与电源配置。

## 2. 总体测试流程 (Workflow)

自动化脚本执行顺序严格遵循以下四个阶段：

1. **初始化连接**：建立 VISA/串口通信。
2. **上电流程**：执行 Power On Sequence。
3. **循环测试**：遍历 7 个增益档位（-9.6dB 至 8dB），动态配置并扫描。
4. **下电流程**：执行 Power Off Sequence。

---

## 3. 功能需求详情

### 3.1 阶段一：仪器连接与初始化

* **REQ-01 (连接建立)**：
  * 软件需读取 `visa.txt` 获取 DP 电源 VISA 地址 [1]。
  * 建立与 DP 电源、DAC (串口) [1]、万用表 (DM) 的连接。
* **REQ-02 (连接报错)**：
  * **约束**：若任一仪器连接失败（如 VISA 资源未找到、串口被占用），软件必须抛出错误提示（Error Log），**禁止**进入后续上电流程。

### 3.2 阶段二：上电顺序控制 (Power On)

* **REQ-03 (顺序上电)**：
  * 读取 `Power_on_config.txt`，按照定义的 `(DP名称, 通道号, 电压, 限流)` 顺序依次打开电源通道 [5]。
* **REQ-04 (电流判定)**：
  * 上电稳定后，读取各通道实际电流。
  * 读取 `Power_limit_config.txt` [4]，判断实测电流是否在 `(下限, 上限)` 范围内。
  * **异常处理**：若电流超限，记录 FAIL 日志，并根据配置策略决定是否急停。
* **REQ-05 (结果保存)**：
  * 生成文件 `"Power_on_result"+测试时间+".txt"` [1]。

### 3.3 阶段三：多增益档位线性度测试 (核心逻辑)

软件需循环执行 **7 个阶段**（对应开启 1 至 7 个 Cell）。

#### 3.3.1 循环控制参数

| 阶段 (Stage) | 增益 (Gain dB) | 开启 Cell 数量 | 累计 DAC 状态 (-4.5V) | 电源 CH2 电压 (V) |
| :----------- | :------------- | :------------- | :-------------------- | :---------------- |
| 1            | -9.6           | 1              | DAC1                  | 1.9               |
| 2            | -3.6           | 2              | DAC1, DAC2            | 2.2               |
| 3            | 0              | 3              | DAC1...3              | 2.5               |
| 4            | 2              | 4              | DAC1...4              | 2.8               |
| 5            | 4              | 5              | DAC1...5              | 3.1               |
| 6            | 6              | 6              | DAC1...6              | 3.4               |
| 7            | 8              | 7              | DAC1...7              | 3.7               |

*注：电源 CH2 基准为 1.6V [3]，每增加 1 个 Cell 增加 0.3V。*

#### 3.3.2 动态配置修改

在每个循环开始前：

* **REQ-06 (修改 DAC 配置)**：读取并修改 `DAC_Config` [2]，将对应阶段新增的 DAC 通道电压从 -2.5V 修改为 **-4.5V**（保持之前的修改，形成累加）。
* **REQ-07 (修改电源配置)**：读取并修改 `Power_Config` [3]，将 **DP1 CH2** 的电压修改为上述表中的目标值。
* **REQ-08 (硬件刷新)**：调用 GUI 的 `load_config` 函数将新配置下发至仪器。

#### 3.3.3 扫描参数自动计算算法

* **REQ-09 (输入幅度计算)**：
  * **目标输出**：固定为 $\pm 0.25V$。
  * **线性增益 ($G_{lin}$)**：根据公式 $G_{lin} = 10^{(Gain_{dB}/20)}$ 计算。
  * **输入幅度 ($V_{in\_amp}$)**：计算公式为 $V_{in\_amp} = 0.25 / G_{lin}$。
* **REQ-10 (扫描参数生成)**：
  * **点数 ($N$)**：固定 **101** 个点。
  * **初值 (Start)**：$-V_{in\_amp}$。
  * **步长 (Step)**：$(2 \times V_{in\_amp}) / (101 - 1)$。
  * *示例 (0dB 档位)*：Gain=1 -> 输入幅度=0.25V -> Start=-0.25V, Step=0.005V。

#### 3.3.4 执行扫描与保存

* **REQ-11 (执行测试)**：调用 GUI 的 `start_linearity_test` 函数，控制 DAC/DG 进行扫描并读取万用表 [1]。
* **REQ-12 (保存数据)**：生成包含 Gain/DNL/INL 的结果文件，文件名需包含阶段标识（如 `Stage_X`）[1]。

### 3.4 阶段四：下电顺序控制 (Power Off)

* **REQ-13 (测试完成判定)**：仅当 7 个档位测试全部循环结束后，触发下电流程。
* **REQ-14 (逆序下电)**：读取 `Power_on_config.txt` [5]，按照与上电**相反**的顺序关闭通道 [1]。
* **REQ-15 (最终日志)**：记录“All Tests Completed”及下电完成状态。

---

## 4. 输入输出文件规范

* **输入文件**：
  * `visa.txt`: 仪器地址 [1]。
  * `DAC_Config.txt`: 初始 DAC 状态 [2]。
  * `Power_on_config.txt`: 上下电顺序 [5]。
  * `Power_limit_config.txt`: 电流门限 [4]。
  * `Power_Config.txt`: 电源参数 [3]。
* **输出文件**：
  * 上电结果：`Power_on_result_{Time}.txt` [1]。
  * 线性度结果：`dc_linearity_result_Stage_{i}_{Time}.txt`（共 7 份）。
  * 图表：`dc_linearity_plot_Stage_{i}_{Time}.png`。

## 5. 异常处理策略

* **仪器掉线**：在循环测试中，若万用表或串口读取超时，必须中止当前测试，并直接跳转至 **REQ-14 (下电流程)** 以保护设备。
* **计算溢出**：若增益计算导致输入幅度超出 DAC 物理输出范围（如 > 10V），应报错并跳过该档位。
